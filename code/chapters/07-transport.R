## ---- message=FALSE, results='hide'--------------------------------------
library(sf)
library(tidyverse)
library(stplanr)
library(spDataLarge)

## ---- echo=FALSE, eval=FALSE---------------------------------------------
## # code that generated the input data - see also ?bristol_ways
## # source("code/08-transport-data-gen.R")
## # view input data
## summary(bristol_ways)
## summary(bristol_ttwa)
## summary(bristol_region)
## 
## region_all = rbind(bristol_region, bristol_ttwa)
## library(tmap)
## tmap_mode("view")
## qtm(bristol_ways, lines.col = "highway", lines.lwd = 3, lines.palette = c("green", "black", "red")) +
##   tm_scale_bar() +
##   tm_shape(region_all) +
##   tm_borders(lwd = c(5, 7), col = "darkblue")

## ----bristol, echo=FALSE, fig.cap="Bristol's transport network represented by colored lines for active (green), public (railways, black) and private motor (red) modes of travel. Blue border lines represent the inner city boundary and the larger Travel To Work Area (TTWA)."----
knitr::include_graphics("https://user-images.githubusercontent.com/1825120/34452756-985267de-ed3e-11e7-9f59-fda1f3852253.png")

## ---- eval=FALSE, echo=FALSE---------------------------------------------
## if(!require(readODS)) {
##   install.packages("readODS")
## }
## u = "https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/536823/local-area-walking-and-cycling-in-england-2015.zip"
## download.file(u, "local-area-walking-and-cycling-in-england-2015.zip")
## unzip("local-area-walking-and-cycling-in-england-2015.zip")
## View(readODS::read_ods("Table index.ods"))
## cw0103 = readODS::read_ods("cw0103.ods")
## View(cw0103)

## ---- eval=FALSE---------------------------------------------------------
## # requires the development version of osmdata
## # devtools::install_github("ropensci/osmdata")
## bristol_region = osmdata::getbb("Bristol", format_out = "sf_polygon")

## Another issue with small zones is related to anonymity rules.

## ------------------------------------------------------------------------
names(bristol_zones)

## ------------------------------------------------------------------------
zones_attr = group_by(bristol_od, o) %>% 
  summarize_if(is.numeric, sum) %>% 
  rename(geo_code = o)

## ------------------------------------------------------------------------
summary(zones_attr$geo_code %in% bristol_zones$geo_code)

## ------------------------------------------------------------------------
zones_joined = left_join(bristol_zones, zones_attr)
sum(zones_joined$all)
names(zones_joined)

## ------------------------------------------------------------------------
zones_od = group_by(bristol_od, d) %>% 
  summarize_if(is.numeric, sum) %>% 
  dplyr::select(geo_code = d, all_dest = all) %>% 
  inner_join(zones_joined, ., by = "geo_code")

## ----zones, echo=FALSE, fig.cap="Number of trips (commuters) living and working in the region. The left map shows zone of origin of commute trips; the right map shows zone of destination (generated by the script 07-zones.R).", message=FALSE----
source("code/07-zones.R", print.eval = TRUE)

## ------------------------------------------------------------------------
od_top5 = arrange(bristol_od, desc(all)) %>% 
  top_n(5, wt = all)

## ----od, echo=FALSE------------------------------------------------------
od_top5 %>% 
  knitr::kable(caption = "Sample of the origin-destination data stored in the data frame object `bristol_od`. These represent the top 5 most common desire lines between zones in the study area.")

## ------------------------------------------------------------------------
od_intra = filter(bristol_od, o == d)
od_inter = filter(bristol_od, o != d)
desire_lines = od2line(od_inter, zones_od)

## ---- eval=FALSE---------------------------------------------------------
## plot(desire_lines$geometry, lwd = desire_lines$all / 500)

## ----desire, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Desire lines representing trip patterns in the Bristol Travel to Work Area. The four black lines represent the object the top 5 desire lines illustrated in Table 7.1."----
# tmap figure
# u_od = "https://user-images.githubusercontent.com/1825120/34081176-74fd39c8-e341-11e7-9f3e-b98807cb113b.png"
# knitr::include_graphics(u_od)
library(tmap)
tmap_mode("plot")
desire_lines_top5 = od2line(od_top5, zones_od)
tm_shape(desire_lines) +
  tm_lines(lwd = "all", scale = 7, title.lwd = "Number of trips", alpha = 0.6) +
  tm_shape(desire_lines_top5) +
  tm_lines(lwd = 5, col = "black", alpha = 0.7) +
  tm_scale_bar()

## ---- message=FALSE------------------------------------------------------
desire_lines$distance = as.numeric(st_length(desire_lines))
desire_carshort = dplyr::filter(desire_lines, car_driver > 300 & distance < 5000)

## ---- eval=FALSE---------------------------------------------------------
## route_carshort = line2route(desire_carshort, route_fun = route_osrm)

## ------------------------------------------------------------------------
desire_carshort$geom_car = route_carshort$geometry

## ----routes, warning=FALSE, fig.cap="Routes along which many (300+) short (<5km Euclidean distance) car journeys are made (red) overlaying desire lines representing the same trips (black) and zone centroids (dots)."----
plot(desire_carshort$geometry)
plot(desire_carshort$geom_car, col = "red", add = TRUE)
plot(st_centroid(zones_od)$geometry, add = TRUE)

## ------------------------------------------------------------------------
desire_rail = top_n(desire_lines, n = 3, wt = train)

## ------------------------------------------------------------------------
mat_orig = as.matrix(line2df(desire_rail)[c("fx", "fy")])
mat_dest = as.matrix(line2df(desire_rail)[c("tx", "ty")])
mat_rail = st_coordinates(bristol_stations)

## ------------------------------------------------------------------------
knn_orig = nabor::knn(mat_rail, query = mat_orig, k = 1)$nn.idx
knn_dest = nabor::knn(mat_rail, query = mat_dest, k = 1)$nn.idx

## ------------------------------------------------------------------------
as.numeric(knn_orig)
as.numeric(knn_dest)

## ------------------------------------------------------------------------
mat_rail_o = mat_rail[knn_orig, ]
mat_rail_d = mat_rail[knn_dest, ]

## ------------------------------------------------------------------------
mats2line = function(mat1, mat2) {
  lapply(1:nrow(mat1), function(i) {
    rbind(mat1[i, ], mat2[i, ]) %>%
    st_linestring()
  }) %>% st_sfc()
}
desire_rail$leg_orig = mats2line(mat_orig, mat_rail_o)
desire_rail$leg_rail = mats2line(mat_rail_o, mat_rail_d)
desire_rail$leg_dest = mats2line(mat_rail_d, mat_dest)

## ---- eval=FALSE, echo=FALSE---------------------------------------------
## # Create equivalent geographic objects using multilinestrings:
## tmp = lapply(1:nrow(mat_orig), function(i) {
##       list(
##         st_linestring(rbind(mat_orig[i, ], mat_rail_o[i, ])),
##         st_linestring(rbind(mat_rail_o[i, ], mat_rail_d[i, ])),
##         st_linestring(rbind(mat_rail_d[i, ], mat_dest[i, ]))) %>%
##   st_multilinestring
##   })
## tmp = st_sfc(tmp)
## plot(tmp, type = "n")
## lapply(tmp, function(x) plot(x[[1]], col = "red", add = TRUE))
## lapply(tmp, function(x) plot(x[[2]], col = "blue", add = TRUE))
## lapply(tmp, function(x) plot(x[[3]], col = "green", add = TRUE))

## ----stations, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Station nodes (red dots) used as intermediary points that convert straight desire lines with high rail usage (black) into three legs: to the origin station (red) via public transport (grey) and to the destination (a very short blue line)."----
zone_cents = st_centroid(zones_od)
zone_cents_rail = zone_cents[desire_rail,]
plot(desire_rail$geometry, expandBB = c(.1, .1, .1, .1))
plot(desire_rail$leg_orig, add = TRUE, col = "red", lwd = 3)
plot(desire_rail$leg_rail, add = TRUE, col = "grey", lwd = 2)
plot(bristol_stations, add = TRUE, col = "red")
plot(desire_rail$leg_dest, add = TRUE, col = "blue", lwd = 5)
plot(zone_cents_rail, add = TRUE, col = "black")
# library(tmap)
# tmap_mode("plot")
# qtm(bristol_stations, basemaps = "https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=feae177da543411c9efa64160305212d", dots.col = "red", symbols.size = 2) +
#   tm_shape(desire_rail) +
#   tm_lines(col = "black", lwd = 4) +
#   tm_shape(legs) +
#   tm_lines()

## ------------------------------------------------------------------------
summary(bristol_ways)

## ------------------------------------------------------------------------
ways_freeway = bristol_ways %>% filter(maxspeed == "70 mph") 
ways_sln = SpatialLinesNetwork(ways_freeway)
slotNames(ways_sln)
weightfield(ways_sln)
class(ways_sln@g)

## ---- fig.cap="Illustration of a small route network, with segment thickness proportional to its betweeness, generated using the **igraph** package and described in the text."----
g = ways_sln@g
e = igraph::edge_betweenness(ways_sln@g)
plot(ways_sln@sl$geometry, lwd = e / 500)

## ---- eval=FALSE, echo=FALSE---------------------------------------------
## # not producing groups of routes so removing for now...
## m = igraph::clusters(g)
## igraph::V(g)$m = m$membership
## gdf = as_long_data_frame(g)

## ------------------------------------------------------------------------
path = sum_network_routes(ways_sln, 1, 20, "length")

## ---- eval=FALSE---------------------------------------------------------
## plot(path$geometry, col = "red", lwd = 10)
## plot(ways_sln@sl$geometry, add = TRUE)

## ---- eval=FALSE---------------------------------------------------------
## route_rail = st_set_geometry(desire_rail, "leg_orig") %>%
##   line2route(route_fun = route_osrm) %>%
##   st_set_crs(4326)

## ------------------------------------------------------------------------
route_cycleway = rbind(route_rail, route_carshort)
route_cycleway$all = c(desire_rail$all, desire_carshort$all)

## ---- eval=FALSE, echo=FALSE---------------------------------------------
## n_trips = route_cycleway$all / 100
## plot(route_cycleway["distance"], lwd = n_trips)

## ----cycleways, echo=FALSE, message=FALSE, fig.cap="Potential routes along which to prioritise cycle infrastructure in Bristol, based on access key rail stations (red dots) and routes with many short car journeys (north of Bristol surrounding Stoke Bradley). Line thickness is proportional to number of trips."----
source("code/07-cycleways.R")
tmap::tmap_leaflet(m_leaflet)

## ---- eval=FALSE, echo=FALSE---------------------------------------------
## sum(route_cycleway$distance)
## sum(st_length(route_cycleway))

## ---- echo=FALSE, eval=FALSE---------------------------------------------
## sum(route_cycleway$all) / sum(desire_lines$all) # around 2%
## d_intersect = desire_lines[route_cycleway, , op = st_crosses]
## sum(d_intersect$all) / sum(desire_lines$all) # around 2%

